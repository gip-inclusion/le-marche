{% load dsfr_tags %}

<form
  class="activity-form-class"
  hx-post="{% url 'dashboard_siaes:siae_activities_edit' pk=object.pk %}"
  x-data="{selectedGeoRange: '{{ form.geo_range.value }}' } "
  x-init="() => {
      const radioInputs = document.getElementsByName('{{ form.geo_range.html_name }}');
      radioInputs.forEach(radio => {
          radio.addEventListener('change', function() {
              if (this.checked) {
                  selectedGeoRange = this.value;
              }
          });
      });
  }"
  {# This form submission is triggered by an external event. #}
  hx-trigger="submitAllForms from:body"
  hx-swap="outerHTML"
>
    {% csrf_token %}
    {# sector is hiddeninput widget from form #}
    {% dsfr_form_field form.sector %}
    {% dsfr_form_field form.presta_type %}
    {% dsfr_form_field form.geo_range %}


{#fixme pas de hardcode#}
    <div x-show="selectedGeoRange === 'CUSTOM'">
      {% dsfr_form_field form.geo_range_custom_distance %}
    </div>

    <div x-show="selectedGeoRange === 'ZONES'">
      {% dsfr_form_field form.locations %}
      {# Sorry for this horror, apparently PerimetersMultiAutocomplete is supposed to work  #}
      {# with that. because multple select can be shown on page, the 'script' json data needs#}
      {# to have a unique id#}
      {% with object.id|stringformat:'s'|add:"-current-locations-activity" as script_name %}
        {{ current_locations|json_script:script_name }}
      {% endwith %}
    </div>

  <button
      class="fr-btn fr-btn--secondary"
      hx-get="{% url 'dashboard_siaes:siae_activities_detail' pk=object.pk %}"
      hx-swap="outerHTML"
      hx-target="#activity-edit-form-{{ object.pk }}"
  >
    Annuler
  </button>
  <button class="fr-btn" type="submit">Enregistrer</button>
</form>

<script type="text/javascript" defer>
    /*Wrapped in a function to avoid scope clash with other forms instances*/
    {# fixme This stuff is a nightmare and should be reworked #}
    (function() {
      let LOCATION_AUTOCOMPLETE_ID = 'id_locations-{{ form.locations.id_for_label }}';
      let LOCATION_AUTOCOMPLETE_CONTAINER_SELECTOR = '#{{ form.locations.id_for_label }}';
      let LOCATION_SELECTED_CONTAINER_SELECTOR = '#locations-selected-{{ form.locations.id_for_label }}';
      let LOCATION_HIDDEN_INPUT_SELECTOR_PREFIX = 'hiddenLocation-{{ form.locations.id_for_label }}';
      let LOCATION_CURRENT_ID = '{{ object.id }}-current-locations-activity';
      let locationsAutoComplete = new PerimetersMultiAutocomplete(
          LOCATION_AUTOCOMPLETE_ID,
          LOCATION_AUTOCOMPLETE_CONTAINER_SELECTOR,
          LOCATION_SELECTED_CONTAINER_SELECTOR,
          LOCATION_HIDDEN_INPUT_SELECTOR_PREFIX,
          LOCATION_CURRENT_ID
      );
      locationsAutoComplete.init();
    })()
  </script>
