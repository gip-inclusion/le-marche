{% extends "layouts/base.html" %}
{% load static bootstrap4 show_first_form_error_message %}

{% block title %}Recherche{{ block.super }}{% endblock %}

{% block breadcrumbs %}
<section>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav class="c-breadcrumb c-breadcrumb--marche" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'pages:home' %}">Accueil</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Recherche</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<section class="s-siae-01">
    <div class="container">
        <div id="dir_form" class="dir_form">
            <form method="GET" action="{% url 'siae:search_results' %}" id="search-form">
                {% if form.errors %}
                    <div class="alert alert-danger" role="alert">{{ form.errors|show_first_form_error_message }}</div>
                {% endif %}
                <div class="row">
                    <div class="col-12 col-lg-8">
                        <div class="row first-row">
                            <div class="col-12 col-md-6 mt-lg-3 pr-md-0">
                                {% bootstrap_field form.sectors %}
                            </div>
                            {% bootstrap_field form.perimeter %}
                            <div class="col-12 col-md-6 mt-lg-3">
                                <div id="dir_form_perimeter_name" class="form-group">
                                    <label for="perimeter_name">{{ form.perimeter_name.label }}</label>
                                    <div class="field-holder">
                                        <div>
                                            {# {{ form.perimeter_name }} #}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 col-md-6 mt-lg-3 pr-md-0">
                                {% bootstrap_field form.kind %}
                            </div>
                            <div class="col-12 col-md-6 mt-lg-3">
                                {% bootstrap_field form.presta_type %}
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-2 mt-3 pr-md-0 pr-lg-2">
                        <span class="mb-2 d-none d-md-inline-block">&nbsp;</span>
                        <button id="filter-submit" class="btn btn-primary btn-block btn-ico" type="submit">
                            <span>Rechercher</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none">
                                <path d="M12.523 10.963l3.213 3.211-1.062 1.062-3.211-3.213A6.72 6.72 0 017.25 13.5 6.752 6.752 0 01.5 6.75 6.752 6.752 0 017.25 0 6.752 6.752 0 0114 6.75a6.72 6.72 0 01-1.477 4.213zm-1.504-.557A5.233 5.233 0 0012.5 6.75c0-2.901-2.35-5.25-5.25-5.25A5.248 5.248 0 002 6.75C2 9.65 4.349 12 7.25 12a5.233 5.233 0 003.656-1.481l.113-.113z" fill="currentColor" />
                            </svg>
                        </button>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-2 mt-3 pl-lg-2">
                        <span class="mb-2 d-none d-md-inline-block">&nbsp;</span>
                        <a href="{% url 'siae:search_results' %}" class="btn btn-outline-primary btn-block reset btn-ico">
                            <span>Réinitialiser</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5.463 4.43301C7.27756 2.86067 9.59899 1.99666 12 2.00001C17.523 2.00001 22 6.47701 22 12C22 14.136 21.33 16.116 20.19 17.74L17 12H20C20.0001 10.4316 19.5392 8.89781 18.6747 7.58927C17.8101 6.28072 16.5799 5.25517 15.1372 4.64013C13.6944 4.0251 12.1027 3.84771 10.56 4.13003C9.0172 4.41234 7.59145 5.14191 6.46 6.22801L5.463 4.43301ZM18.537 19.567C16.7224 21.1393 14.401 22.0034 12 22C6.477 22 2 17.523 2 12C2 9.86401 2.67 7.88401 3.81 6.26001L7 12H4C3.99987 13.5684 4.46075 15.1022 5.32534 16.4108C6.18992 17.7193 7.42007 18.7449 8.86282 19.3599C10.3056 19.9749 11.8973 20.1523 13.44 19.87C14.9828 19.5877 16.4085 18.8581 17.54 17.772L18.537 19.567Z" fill="currentColor" />
                            </svg>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<section class="s-siae-02">
    <div class="container">
        <div id="dir_list">
            <div class="row">
                <div class="col-12">
                    <div class="meta h2 mb-3 mb-md-6 mt-3 mt-3 font-weight-light text-center text-md-left">
                        {% with paginator.count as siae_count %}
                            {{ siae_count }} structures correspondent à vos critères
                        {% endwith %}
                    </div>
                </div>
            </div>
            <div class="row dir_list-row">
                <div class="col-12 col-md-8">
                {% if siaes %}
                    {% for siae in siaes %}
                        {% include "siaes/_card_search_result.html" with siae=siae %}
                    {% endfor %}
    
                    {% include "includes/_pagination.html" %}

                    <br />

                    <div class="row justify-content-center">
                        <div class="col-sm-6">
                            {% if user.is_authenticated %}
                                <a href="{% url 'siae:search_results_download' %}?{{ current_search_query }}" id="csv-submit" class="btn btn-block btn-outline-primary" target="_blank">
                                    Télécharger la liste
                                </a>
                            {% else %}
                                <a href="{% url 'auth:login' %}?message=login-to-download&next={% url 'siae:search_results' %}?{{ current_search_query }}" id="csv-submit" class="btn btn-block btn-outline-primary">
                                    Télécharger la liste
                                </a>
                            {% endif %}
                        </div>
                    </div>
    
                {% else %}
                    <div class="col-12 form-confirm min-height justify-content-center">
                        <div class="no-results">
                            <div style="text-align:center">
                                <img src="{% static 'img/home_help_icon_white.png' %}" style="height:64px;margin-bottom:1rem;" alt="icon description" class="icon">
                            </div>
                            <p>Malheureusement, nous n'avons pas encore de prestataires correspondant à votre recherche sur La place de marché de l'inclusion.</p>
                            <p>
                                <strong>Faites nous part de votre besoin et nous vous recontacterons rapidement</strong>
                            </p>
                            <div class="buttonrow">
                                <a href="https://itou.typeform.com/to/nxG0HlYx" class="btn btn-primary">Déposez votre demande</a>
                            </div>
                        </div>
                    </div>
                {% endif %}
                </div>
                <div class="col-12 col-md-4 siae-info mt-6 mt-sm-0">
                    <div class="siae-info-sticky">
                        <div class="maparea">
                            <div class="map-holder">
                                <div id="map-siae-list" class="map-canvas"></div>
                            </div>
                        </div>
                        <div class="si-separator"></div>
                        <div class="si-ideas">
                            <h3 class="h3 my-3">Idées reçues</h3>
                            <p>
                                <img src="{% static 'img/check.svg' %}" style="height:22px" /> 
                                <span>La structure est trop petite pour répondre à mon besoin...
                                <b>Mais elle est sûrement ouverte à la co-traitance.</b>
                                </span>
                            </p>
                            <p>
                                <img src="{% static 'img/check.svg' %}" style="height:22px" />
                                <span>Son chiffre d’affaire est trop bas et je ne veux pas être
                                son seul client... <b>Mais Vous pouvez commencer par lui confier
                                un marché de plus faible périmètre, sans prendre de risque,
                                puis faire grandir ce partenariat si vous en êtes satisfait.</b>
                                </span>
                            </p>
                            <p>
                                <img src="{% static 'img/check.svg' %}" style="height:22px" />
                                <span>L'offre ne correspond pas exactement à ce que je cherche...
                                <b>Heureusement les entreprises sociales inclusives sont très
                                innovantes et s'adaptent à vos besoins.</b>
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
    
            {% comment "hidden" %}
            {{ form_start(dlform) }}
            <div id="csv_form" class="row dir_form mb-5 align-items-end">
                {{ form_widget(dlform.sector, {'attr': {'style': 'display:none', 'class': 'jcf-ignore'}}) }}
                {#
                {{ form_widget(dlform.withAntenna, {'attr': {'style': 'display:none'}}) }}
                {{ form_widget(dlform.withRange, {'attr': {'style': 'display:none'}}) }}
                #}
                {{ form_widget(dlform.prestaType, {'attr': {'style': 'display:none'}}) }}
                {{ form_widget(dlform.structureType, {'attr': {'style': 'display:none', 'class': 'jcf-ignore'}}) }}
                {% do dlform.structureType.setRendered() %}
                {% do dlform.address.setRendered() %}
                <div class="col-12 col-md-3 offset-md-1 mt-lg-3">
                    <div class="title d-block font-weight-bold mb-2">Format d'export</div>
                    <div class="field-holder">
                        {{form_widget(dlform.format,{
                            'id': 'format'
                        })}}
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <button id="csv-submit" type="submit" class="btn btn-block btn-outline-primary">
                        Télécharger la liste
                    </button>
                </div>
            </div>
            {{ form_end(dlform) }}
            {% endcomment %}
        </div>
    </div>
</section>
{% endblock %}

{% block modal %}
<div class="modal fade modal-siae" id="user_modal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false" style="z-index:3000">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <strong class="title">
                    Plus de {{ paginator.count }} prestataires inclusifs répondent à votre recherche.
                </strong>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body home-content-body">
                <p class="mt-2">Pour accéder aux résultats, dites-nous si vous êtes :
                <ul style="padding-left:0;list-style:none;">
                    <li><a href="#" data-usr="buyer" class="btn btn-outline-primary btn-block mb-2" style="text-align:left;">Une entreprise ou une institution qui souhaite augmenter ses achats inclusifs</a></li>
                    <li><a href="#" data-usr="siae" class="btn btn-outline-primary btn-block mb-2" style="text-align:left;">Une structure d’insertion ou du handicap</a></li>
                    <li><a href="#" data-usr="actor" class="btn btn-outline-primary btn-block mb-2" style="text-align:left;">Un acteur de l’inclusion (facilitateurs, réseaux...)</a></li>
                </ul>
            </div>
            <!-- <div class="modal-footer"></div> -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if not user.is_authenticated %}
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // show type user modal
        const USER_TYPE_MODAL_COOKIE_NAME = 'leMarcheTypeUsagerV2';
        $(document).on('shown.bs.modal', '.modal', function () {
            $('.modal-backdrop').before($(this));
        });

        if (!document.cookie.split('; ').find(row => row.startsWith(USER_TYPE_MODAL_COOKIE_NAME))) {
            var modal = $("#user_modal");
            modal.find('.close').remove();
            modal.modal('show');

            modal.find('a').on('click', (e) => {
                // Only set cookie if button clicked
                let type = $(e.target).data('usr');
                document.cookie = `${USER_TYPE_MODAL_COOKIE_NAME}=${type}; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/; Secure`;

                if (typeof track === "function") {
                    track('', Steps.USER_TYPE, {'type': type});
                }
                modal.modal('hide');
            })
        }
    });
</script>
{% endif %}
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // Set listings markers on load
        const siaeList = {{ siaes_json|safe }};

        // init map
        var map = L.map('map-siae-list').setView([47.08333, 2.4], 5);

        // map tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19,
            zoomControl: false,
        }).addTo(map);

        // map zoom controls in the bottom right
        map.zoomControl.remove();
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // create custom marker (because of static url issues)
        var customLeafletIcon = L.icon({
            'iconUrl': "{% static 'vendor/leaflet-1.7.1/images/marker-icon.png' %}",
            'shadowUrl': "{% static 'vendor/leaflet-1.7.1/images/marker-shadow.png' %}",
            iconSize: [25,41],
            iconAnchor: [12,41],
            popupAnchor:[1,-34],
            tooltipAnchor:[16,-28],
            shadowSize:[41,41],
        });

        // add markers from geojson data (with popup on click)
        var geojson = L.geoJSON(siaeList, {
            pointToLayer: function(geoJsonPoint, latlng) {
                return L.marker(latlng, {icon: customLeafletIcon});
            },
            onEachFeature: function (feature, layer) {
                var featureDisplayName = feature.properties.brand ? feature.properties.brand : feature.properties.name;
                layer.bindPopup(`<a href="/prestataires/${feature.properties.slug}/"><p class="h6">${featureDisplayName}</p></a>`);
            }
        }).addTo(map);
        map.fitBounds(geojson.getBounds());
    });
</script>
{% endblock %}
