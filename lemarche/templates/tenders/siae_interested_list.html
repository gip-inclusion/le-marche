{% extends BASE_TEMPLATE %}
{% load dsfr_tags static %}
{% block page_title %}
    Prestataires ciblés & intéressés par mon besoin{{ block.super }}
{% endblock page_title %}
{% block breadcrumb %}
    {% dsfr_breadcrumb %}
{% endblock breadcrumb %}
{% block content %}
    <section>
        <div class="fr-container">
            <div class="fr-grid-row fr-mb-12v">
                <div class="fr-col-12">
                    <div class="fr-card">
                        <div class="fr-card__body">
                            <div class="fr-card__content">
                                <form method="get" role="search" id="filter-search-form">
                                    {% if form.non_field_errors %}
                                        <section class="fr-my-4v fr-input-group fr-input-group--error">
                                            {{ form.non_field_errors }}
                                        </section>
                                    {% endif %}
                                    <div class="fr-grid-row fr-grid-row--gutters">
                                        <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">
                                            <div class="form-group">
                                                <label for="id_locations">{{ form.locations.label }}</label>
                                                <div id="dir_form_locations" data-input-name="{{ form.locations.name }}"></div>
                                                <div id="locations-selected" class="mt-2"></div>
                                                {{ current_locations|json_script:"current-locations" }}
                                            </div>
                                        </div>
                                        <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">{% dsfr_form_field form.kind %}</div>
                                        <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">{% dsfr_form_field form.territory %}</div>
                                        <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">{% dsfr_form_field form.employees %}</div>
                                        <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">{% dsfr_form_field form.ca %}</div>
                                        <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">
                                            <div class="fr-mb-2v fr-hidden fr-unhidden-md">&nbsp;</div>
                                            <button id="text-search-submit"
                                                    class="fr-btn fr-btn--icon-right fr-icon-search-line"
                                                    type="submit">Filtrer</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% block htmx %}
                <div id="tenderSiaeList">
                    <div class="fr-grid-row fr-grid-row--gutters fr-mb-8v">
                        <div class="fr-col-12">
                            <div class="fr-tabs">
                                <ul class="fr-tabs__list" role="tablist" aria-label="Filtre Status">
                                    {% url 'tenders:detail-siae-list' slug=tender.slug as TENDER_SIAE_LIST_URL %}
                                    {% url 'tenders:detail-siae-list' slug=tender.slug status="VIEWED" as TENDER_SIAE_DETAIL_CONTACT_VIEW_LIST_URL %}
                                    {% url 'tenders:detail-siae-list' slug=tender.slug status="INTERESTED" as TENDER_SIAE_DETAIL_CONTACT_CLICK_LIST_URL %}
                                    <li role="presentation">
                                        <a role="button"
                                           hx-push-url="true"
                                           hx-target="#tenderSiaeList"
                                           hx-swap="outerHTML"
                                           class="fr-tabs__tab"
                                           hx-get="{{ TENDER_SIAE_LIST_URL }}?{{ current_search_query }}"
                                           href="{{ TENDER_SIAE_LIST_URL }}?{{ current_search_query }}"
                                           aria-controls="tender_siae_list_panel_None"
                                           aria-selected="{% if request.path == TENDER_SIAE_LIST_URL %}true{% else %}false{% endif %}">
                                            Prestataires ciblés
                                        </a>
                                    </li>
                                    <li role="presentation">
                                        <a role="button"
                                           hx-push-url="true"
                                           hx-target="#tenderSiaeList"
                                           hx-swap="outerHTML"
                                           class="fr-tabs__tab"
                                           hx-get="{{ TENDER_SIAE_DETAIL_CONTACT_VIEW_LIST_URL }}?{{ current_search_query }}"
                                           href="{{ TENDER_SIAE_DETAIL_CONTACT_VIEW_LIST_URL }}?{{ current_search_query }}"
                                           aria-controls="tender_siae_list_panel_VIEWED"
                                           aria-selected="{% if request.path == TENDER_SIAE_DETAIL_CONTACT_VIEW_LIST_URL %}true{% else %}false{% endif %}">
                                            Prestataires qui ont vu
                                        </a>
                                    </li>
                                    <li role="presentation">
                                        <a role="button"
                                           hx-push-url="true"
                                           hx-target="#tenderSiaeList"
                                           hx-swap="outerHTML"
                                           class="fr-tabs__tab"
                                           hx-get="{{ TENDER_SIAE_DETAIL_CONTACT_CLICK_LIST_URL }}?{{ current_search_query }}"
                                           href="{{ TENDER_SIAE_DETAIL_CONTACT_CLICK_LIST_URL }}?{{ current_search_query }}"
                                           aria-controls="tender_siae_list_panel_INTERESTED"
                                           aria-selected="{% if request.path == TENDER_SIAE_DETAIL_CONTACT_CLICK_LIST_URL %}true{% else %}false{% endif %}">
                                            Prestataires intéressés
                                        </a>
                                    </li>
                                </ul>
                                <div id="tender_siae_list_panel_{{ status }}"
                                     class="fr-tabs__panel fr-tabs__panel--selected"
                                     role="tabpanel"
                                     tabindex="0">
                                    <div class="fr-grid-row fr-grid-row--gutters fr-mb-4v">
                                        <div class="fr-col-12 fr-col-lg-6">
                                            <h1>{{ siaes.count }} prestataire{{ siaes.count|pluralize }}</h1>
                                        </div>
                                        <div class="fr-col-12 fr-col-lg-6">
                                            <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-md fr-btns-group--icon-left">
                                                {% if not status == 'INTERESTED' %}
                                                <li>
                                                     <span class="fr-tooltip fr-placement"
                                                          id="tooltip-reminder"
                                                          role="tooltip"
                                                          aria-hidden="true">
                                                         {{ reminder_tooltip }}
                                                     </span>
                                                    <button type="button"
                                                          class="fr-btn fr-btn--icon-left"
                                                          data-fr-opened="false"
                                                          aria-controls="fr-modal-reminder"
                                                          style="position: relative;"
                                                          {% if reminder_disabled %}disabled{% endif %}
                                                          aria-describedby="tooltip-reminder"
                                                    >
                                                        <span class="fr-badge fr-badge--sm fr-badge--new"
                                                              style="position: absolute; top: -8px; right: -8px;">
                                                            Nouveau
                                                        </span>
                                                    Relancer les fournisseurs
                                                    </button>
                                                </li>
                                                {% endif %}
                                                <li>
                                                  <button type="button"
                                                          class="fr-btn fr-btn--tertiary fr-icon-download-fill fr-btn--icon-left"
                                                          data-fr-opened="false"
                                                          aria-controls="fr-modal-download">
                                                    Exporter
                                                  </button>
                                                </li>
                                            </ul>
                                            <dialog aria-labelledby="fr-modal-reminder-title" role="dialog" id="fr-modal-reminder"
                                                  class="fr-modal">
                                                <div class="fr-container fr-container--fluid fr-container-md">
                                                    <div class="fr-grid-row fr-grid-row--center">
                                                        <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                                                            <div class="fr-modal__body"
                                                                 hx-get="{% url 'tenders:send-reminder' tender.slug status %}"
                                                                 hx-trigger="load"
                                                                 hx-swap="innerHTML"
                                                              >
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </dialog>


                                          <dialog aria-labelledby="fr-modal-download-title" role="dialog" id="fr-modal-download"
                                                  class="fr-modal">
                                            <div class="fr-container fr-container--fluid fr-container-md">
                                              <div class="fr-grid-row fr-grid-row--center">
                                                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                                                  <div class="fr-modal__body">
                                                    <div class="fr-modal__header">
                                                      <button class="fr-btn--close fr-btn" title="Fermer la fenêtre"
                                                              aria-controls="fr-modal-download">Fermer
                                                      </button>
                                                    </div>
                                                    <div class="fr-modal__content">
                                                      <h1 id="fr-modal-download-title" class="fr-modal__title">
                                                        Personnaliser mon export
                                                      </h1>
                                                      <p>Sélectionner le format et les informations à inclure dans votre export Excel.
                                                      </p>
                                                      <form method="get"
                                                            id="download-form"
                                                            action="{% url 'tenders:download-siae-list' slug=tender.slug %}">
                                                        {% dsfr_form_field download_form.format %}
                                                        <input type="hidden" name="tendersiae_status" value="{{ status|default:"" }}">

                                                        {# These clickable tags will act as checkboxes, and their value will be linked #}
                                                        {# to the real checkboxes via js #}
                                                        <label class="fr-label">{{ download_form.selected_fields.label }}</label>

                                                          <ul class="fr-tags-group">
                                                            {% for value, label in download_form.selected_fields.field.choices %}
                                                            <li x-data="{ {{ value }}: false }">
                                                                {# real checkbox are hidden here, they are used for form submission #}
                                                              <input type="checkbox"
                                                                     name="{{ download_form.selected_fields.html_name }}"
                                                                     value="{{ value }}"
                                                                     x-model="{{ value }}"
                                                                     style="display: none;"
                                                              >

                                                              <button type="button" class="fr-tag"
                                                                      x-on:click="{{ value }} = !{{ value }}"
                                                                      aria-pressed="false"
                                                              >
                                                                  {{ label }}
                                                              </button>
                                                            </li>
                                                            {% endfor %}
                                                          </ul>

                                                      </form>

                                                    </div>
                                                    <div class="fr-modal__footer">
                                                      <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg">
                                                        <li>
                                                          <button
                                                             class="fr-btn"
                                                             type="submit"
                                                             form="download-form"
                                                             id="tender-siae-interested-export-xls">
                                                            Générer l’export
                                                          </button>
                                                        </li>
                                                        <li>
                                                          <button class="fr-btn fr-btn--secondary"
                                                                  aria-controls="fr-modal-download">Retour
                                                          </button>
                                                        </li>
                                                      </ul>
                                                    </div>
                                                  </div>
                                                </div>
                                              </div>
                                            </div>
                                          </dialog>
                                        </div>
                                    </div>
                                    <div class="fr-grid-row fr-grid-row--gutters">
                                        {% for siae in siaes %}
                                            <div class="fr-col-12">{% include "siaes/_card_tender.html" with siae=siae %}</div>
                                        {% endfor %}
                                        {% include "includes/_pagination.html" %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endblock htmx %}
        </div>
    </section>
    {% include "includes/_super_siae_arguments_badge.html" %}
{% endblock content %}
{% block extra_js %}
    <script type="text/javascript" src="{% static 'js/perimeter_autocomplete_field.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/multiselect.js' %}"></script>
    
    <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        const LOCATION_AUTOCOMPLETE_ID = 'id_locations';
        const LOCATION_AUTOCOMPLETE_CONTAINER_SELECTOR = '#dir_form_locations';
        const LOCATION_SELECTED_CONTAINER_SELECTOR = '#locations-selected';
        const LOCATION_HIDDEN_INPUT_SELECTOR_PREFIX = 'hiddenLocation';
        const LOCATION_CURRENT_ID = 'current-locations';
        const locationsAutoComplete = new PerimetersMultiAutocomplete(LOCATION_AUTOCOMPLETE_ID, LOCATION_AUTOCOMPLETE_CONTAINER_SELECTOR, LOCATION_SELECTED_CONTAINER_SELECTOR, LOCATION_HIDDEN_INPUT_SELECTOR_PREFIX, LOCATION_CURRENT_ID);
        locationsAutoComplete.init();
    });
    </script>
    <script>
        /*Script to add the filter form parameter to the form used to download results in a file.
        * Results in the file should be filtered just as the ones displayed on the page*/

        // Get download-form
        const downloadForm = document.getElementById('download-form');

        // listen to submit button event
        downloadForm.addEventListener('submit', function(event) {

            // get current url param, used to filter results
            const currentUrlParams = new URLSearchParams(window.location.search);

            // create a hidden input in the download form for each url param
            for (const [key, value] of currentUrlParams.entries()) {

                // check if not empty
                if (value) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = key;
                    hiddenInput.value = value;
                    hiddenInput.className = 'filter-param'; // handy class
                    // add to download-form
                    this.appendChild(hiddenInput);
                }
            }
            // submission will go on and params to url will be added according to the download form
        });
    </script>
{% endblock extra_js %}
